name: PII Content Scanner

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited]
  workflow_dispatch:

jobs:
  scan-content:
    name: Scan for PII in Content
    if: "!contains(github.actor, '[bot]')"
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Scan Issue/PR Content for PII
        uses: actions/github-script@v7
        with:
          script: |
            const piiPatterns = {
              email: {
                pattern: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/gi,
                exclude: /example\.com|test\.com|localhost|your-?email|user@|email@|foo@|bar@|noreply@|github\.com/i,
                label: 'Email addresses'
              },
              phone: {
                pattern: /\+?1?[-.\s]?\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4}/g,
                exclude: /000-000-0000|123-456-7890|555-/i,
                label: 'Phone numbers'
              },
              ssn: {
                pattern: /\b[0-9]{3}-[0-9]{2}-[0-9]{4}\b/g,
                exclude: /000-00-0000|123-45-6789/,
                label: 'SSN patterns'
              },
              creditCard: {
                pattern: /\b[3-6][0-9]{3}[-\s]?[0-9]{4}[-\s]?[0-9]{4}[-\s]?[0-9]{4}\b/g,
                exclude: /0000-0000-0000-0000|1234-5678/,
                label: 'Credit card numbers'
              },
              awsKey: {
                pattern: /\b(AKIA|ABIA|ACCA|ASIA)[0-9A-Z]{16}\b/g,
                exclude: null,
                label: 'AWS access keys'
              },
              privateKey: {
                pattern: /-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----/g,
                exclude: null,
                label: 'Private keys'
              }
            };

            let content = '';
            let contentType = '';
            let contentNumber = 0;

            if (context.eventName === 'issues') {
              content = context.payload.issue.body || '';
              contentType = 'issue';
              contentNumber = context.payload.issue.number;
            } else if (context.eventName === 'pull_request') {
              content = context.payload.pull_request.body || '';
              contentType = 'pull request';
              contentNumber = context.payload.pull_request.number;
            }

            if (!content) {
              console.log('No content to scan');
              return;
            }

            const findings = [];

            for (const [type, config] of Object.entries(piiPatterns)) {
              const matches = content.match(config.pattern);
              if (matches) {
                const filtered = config.exclude
                  ? matches.filter(m => !config.exclude.test(m))
                  : matches;
                if (filtered.length > 0) {
                  findings.push({
                    type: config.label,
                    count: filtered.length
                  });
                }
              }
            }

            if (findings.length > 0) {
              const warningMessage = `## Warning: Potential PII Detected

            This ${contentType} may contain sensitive personal information:

            ${findings.map(f => `- **${f.type}**: ${f.count} potential match(es)`).join('\n')}

            **This is a public repository.** Please review and remove any personal information before this content is merged or made public.

            If these are false positives (example data, documentation references, etc.), you can ignore this warning.

            ---
            *Automated scan by PII Content Scanner*`;

              if (context.eventName === 'issues') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: contentNumber,
                  body: warningMessage
                });
              } else {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: contentNumber,
                  body: warningMessage,
                  event: 'COMMENT'
                });
              }

              console.log(`PII warning posted to ${contentType} #${contentNumber}`);
            } else {
              console.log('No PII detected in content');
            }
