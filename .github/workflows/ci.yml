name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: '**/*.md'
        continue-on-error: true

      - name: Lint Python files
        uses: py-actions/flake8@v2
        with:
          path: "scripts"
        continue-on-error: true

  validate-config:
    name: Validate Configuration
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          for file in $(find . -name "*.json" -type f); do
            echo "Validating $file"
            python3 -m json.tool "$file" > /dev/null || echo "Invalid JSON: $file"
          done

      - name: Check required files exist
        run: |
          required_files=(
            "README.md"
            "LICENSE"
            "CRUCIBLE_WORKFLOW.md"
            "READING_LIST.md"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Missing required file: $file"
              exit 1
            fi
          done
          echo "All required files present"

  validate-book-structure:
    name: Validate Book Folders
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Check book folder naming convention
        run: |
          echo "Checking book folder naming conventions..."

          # Find directories that look like book folders (contain underscore)
          # Exclude hidden dirs, TEMPLATE, scripts, .github
          for dir in */; do
            dir_name="${dir%/}"

            # Skip non-book directories
            if [[ "$dir_name" == "TEMPLATE" ]] || \
               [[ "$dir_name" == "scripts" ]] || \
               [[ "$dir_name" == "assets" ]] || \
               [[ "$dir_name" =~ ^\. ]]; then
              continue
            fi

            # Check if it matches the naming convention: {book-slug}_{author}
            if [[ "$dir_name" =~ ^[a-z0-9-]+_[a-z]+$ ]]; then
              echo "✓ $dir_name follows naming convention"
            else
              echo "⚠ $dir_name may not follow naming convention (expected: book-title_author)"
            fi
          done

      - name: Check for required phase files
        run: |
          echo "Checking book folders for required files..."

          for dir in */; do
            dir_name="${dir%/}"

            # Skip non-book directories
            if [[ "$dir_name" == "TEMPLATE" ]] || \
               [[ "$dir_name" == "scripts" ]] || \
               [[ "$dir_name" == "assets" ]] || \
               [[ "$dir_name" =~ ^\. ]]; then
              continue
            fi

            # Skip if no underscore (not a book folder)
            if [[ ! "$dir_name" =~ _ ]]; then
              continue
            fi

            echo "Checking $dir_name..."

            # Check for at least the vetting file (Phase 0)
            if [ -f "$dir/00_vetting.md" ]; then
              echo "  ✓ Has 00_vetting.md"
            else
              echo "  ⚠ Missing 00_vetting.md (Phase 0)"
            fi
          done

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      - name: Check for broken internal links
        run: |
          echo "Checking for potentially broken internal links..."

          # Simple check for referenced markdown files
          grep -roh '\[.*\](.*\.md)' *.md 2>/dev/null | \
          grep -oP '\(.*?\)' | tr -d '()' | \
          while read link; do
            if [[ "$link" != http* ]] && [ ! -f "$link" ]; then
              echo "Possibly broken link: $link"
            fi
          done || true
