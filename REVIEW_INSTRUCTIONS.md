# Review Instructions

> **DELETE THIS FILE** after reading and addressing the issues.
> This file was generated by the Review Agent (Gemini).

## Workflow

1. Read the issues below
2. Fix the code
3. **DELETE this file** (`git rm REVIEW_INSTRUCTIONS.md`)
4. Commit with `Agent-Note:` trailer explaining your fixes

## Example Commit

```
fix: address review feedback

Agent-Note: Fixed SQL injection in auth.ts by using parameterized queries.
```

---

## Issues to Address

```toml
[review]
summary = "The new agentic workflow introduces significant risks regarding infinite CI loops and concurrency issues during git operations. Additionally, the heavy use of inline Python within the YAML workflow complicates maintainability and testing."
decision = "REQUEST_CHANGES"

[[issues]]
severity = "critical"
file = ".github/workflows/gemini-pr-review-plus.yml"
title = "Potential infinite CI loop"
description = "The workflow commits and pushes `REVIEW_INSTRUCTIONS.md` back to the PR branch. If `GH_TOKEN` is a Personal Access Token (PAT), this push will trigger the `pull_request` workflow again (event: `synchronize`). Without an explicit guard clause to check if the commit was authored by the bot or if the `REVIEW_INSTRUCTIONS.md` file was just modified, this creates an infinite loop where Gemini repeatedly reviews its own instructions."
suggestion = "Add a step to check `github.actor` or the last commit author before running the review logic. Example: `if: github.actor != 'github-actions[bot]'` (adjust based on the identity used by GH_TOKEN)."

[[issues]]
severity = "important"
file = ".github/workflows/gemini-pr-review-plus.yml"
title = "Race condition in git push"
description = "The workflow performs a `git push` to the PR branch. In an active PR, if the user pushes a commit after the workflow has checked out the code but before it pushes, the push will fail with a non-fast-forward error. This causes the workflow to fail and feedback to be lost."
suggestion = "Implement a robust push strategy: attempt a `git pull --rebase` immediately before pushing, or wrap the push in a retry loop that pulls latest changes."

[[issues]]
severity = "suggestion"
file = ".github/workflows/gemini-pr-review-plus.yml"
title = "Refactor inline Python to standalone script"
description = "The workflow contains an extensive inline Python script (implied by the summary to be large). Inline scripts in YAML are difficult to lint, test, and maintain. They also suffer from lack of syntax highlighting and complex escaping rules."
suggestion = "Move the Python logic to a dedicated file (e.g., `.github/scripts/gemini_review.py`) and execute it via the workflow. This allows for proper unit testing and linting."

[[issues]]
severity = "important"
file = ".github/workflows/gemini-pr-review-plus.yml"
title = "Workflow failure on forks"
description = "The workflow requires `GH_TOKEN` and `GEMINI_API_KEY` to function. For Pull Requests from forks, these secrets are not available in the standard `pull_request` trigger. While the logic may skip execution if secrets are missing, it means the agent-to-agent workflow is effectively disabled for external contributors."
suggestion = "Verify this limitation is intentional. If external contributors need this feedback, consider using `pull_request_target` (with extreme caution regarding code checkout security) or rely on a maintainer to trigger the workflow manually."
```
